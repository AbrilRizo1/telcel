<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Juego Canasta - Navidad</title>
<style>
  :root{
    --ui-bg: rgba(0,0,0,0.4);
    --panel: rgba(255,255,255,0.95);
    --accent: #0078d4;
    --max-width: 900px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:#0b1220;color:#111;}
  .wrap{max-width:var(--max-width);margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px;}
  header{display:flex;align-items:center;gap:12px;}
  header img.logo{height:48px;}
  .stage{position:relative;width:100%;aspect-ratio:16/9;background-size:cover;background-position:center;overflow:hidden;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6);}
  .hud{position:absolute;left:8px;top:8px;background:var(--ui-bg);backdrop-filter:blur(6px);padding:8px 12px;border-radius:10px;color:white;font-weight:600;z-index:30;display:flex;gap:12px;align-items:center;}
  .hud .goal-select select{background:transparent;border:0;color:white;font-weight:600;}
  .controls{position:absolute;right:8px;top:8px;z-index:30;display:flex;gap:8px;}
  button.btn{background:var(--accent);border:0;color:white;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.25);}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.15);color:white;padding:6px 10px;}
  .basket{position:absolute;bottom:8%;left:50%;transform:translateX(-50%);z-index:20;width:18%;max-width:160px;min-width:80px;touch-action:none;transition:transform 0.06s linear;}
  .cookie{position:absolute;width:48px;height:48px;will-change:transform,opacity;user-select:none;pointer-events:none;transform-origin:center;z-index:10;}
  .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.6),rgba(2,6,23,0.8));display:flex;align-items:center;justify-content:center;z-index:60;color:white;padding:20px;backdrop-filter:blur(4px);}
  .panel{background:var(--panel);color:#0b1220;padding:20px;border-radius:12px;max-width:520px;width:100%;text-align:center;}
  .small{font-size:0.9rem;color:#333;margin-top:8px;}
  .instructions{font-size:0.95rem;line-height:1.3;color:white;position:absolute;left:10px;bottom:10px;z-index:40;background:linear-gradient(180deg,rgba(0,0,0,0.35),transparent);padding:8px;border-radius:8px;}
  @media(max-width:600px){.basket{width:26%;}.cookie{width:36px;height:36px;}.hud{font-size:0.85rem}}
</style>
</head>
<body>
<div class="wrap">
<header>
<img src="logo-telcel.png" alt="Telcel" class="logo" />
<h1 style="margin:0;font-size:1.05rem;color:white;">Juego: Atrapa las galletas</h1>
</header>
<main class="stage" id="stage" style="background-image:url('bg-winter.jpg');">
<div class="hud" id="hud">
<div>Contador:<span id="score">0</span></div>
<div style="opacity:.9">Meta:<strong id="goalLabel">10</strong></div>
<div class="goal-select" style="display:flex;align-items:center;gap:6px;">
<label for="goal" style="font-weight:600;color:white">Cambiar</label>
<select id="goal"><option value="10">10</option><option value="15">15</option><option value="20" selected>20</option></select>
</div>
</div>
<div class="controls">
<button id="startBtn" class="btn">Iniciar Juego</button>
<button id="pauseBtn" class="ghost">Pausar</button>
</div>
<div id="basket" class="basket"><img src="basket.png" alt="Canasta" style="width:100%;display:block;"/></div>
<div id="instructions" class="instructions">Mueve el dispositivo o desliza lateralmente para mover la canasta. Toca "Iniciar Juego".</div>
<div id="endOverlay" class="overlay" style="display:none;">
<div class="panel">
<h2 id="endTitle">¡Felicidades!</h2>
<p id="endText">Alcanzaste la meta. ¿Quieres ver la felicitación en AR?</p>
<div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
<button id="viewArBtn" class="btn">Ver Felicitación en AR</button>
<button id="replayBtn" class="ghost">Jugar otra vez</button>
</div>
<p class="small">Nota: la experiencia AR no está implementada en este repositorio.</p>
</div>
</div>
</main>
<section style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
<div style="font-size:.95rem;color:#222;"><strong>Instrucciones:</strong> Atrapa <span id="goalInline">20</span> galletas para ganar. Puedes usar inclinación o tocar y arrastrar.</div>
<div style="font-size:.85rem;color:#555;">Hecho con ❤️ — Reemplaza assets en /assets/</div>
</section>
</div>
<script>

/*
  Juego de canasta - JavaScript
  Notas:
  - Reemplaza las rutas de imagen en `COOKIE_IMAGES` y la canasta si lo deseas.
  - Para iOS 13+ que requiere permiso para DeviceMotion, llamamos a requestDeviceMotionPermission().
*/

const STAGE = document.getElementById('stage');
const BASKET = document.getElementById('basket');
const SCORE_DISPLAY = document.getElementById('score');
const GOAL_INPUT = document.getElementById('goal');
const GOAL_LABEL = document.getElementById('goalLabel');
const GOAL_INLINE = document.getElementById('goalInline');
const START_BTN = document.getElementById('startBtn');
const PAUSE_BTN = document.getElementById('pauseBtn');
const END_OVERLAY = document.getElementById('endOverlay');
const VIEW_AR_BTN = document.getElementById('viewArBtn');
const REPLAY_BTN = document.getElementById('replayBtn');

let stageRect = STAGE.getBoundingClientRect();
let stageWidth = stageRect.width;
let stageHeight = stageRect.height;

const COOKIE_IMAGES = [
  ' cookie1.png',
  ' cookie2.png',
  ' cookie3.png'
]; // reemplaza con tus imágenes (transparencia PNG)

let game = {
  running: false,
  paused: false,
  cookies: [],
  score: 0,
  goal: parseInt(GOAL_INPUT.value,10),
  spawnInterval: 800, // ms entre spawn inicial
  spawnVariance: 400, // variación aleatoria
  speedMin: 80, // px/s
  speedMax: 220, // px/s
  lastSpawn: 0,
  lastTime: null,
  useGyro: false,
  basketX: 0.5 // 0..1 relative position
};

GOAL_LABEL.textContent = game.goal;
GOAL_INLINE.textContent = game.goal;

window.addEventListener('resize', onResize);
GOAL_INPUT.addEventListener('change', ()=>{
  game.goal = parseInt(GOAL_INPUT.value,10);
  GOAL_LABEL.textContent = game.goal;
  GOAL_INLINE.textContent = game.goal;
});

START_BTN.addEventListener('click', ()=>{
  if(!game.running){
    startGame();
  } else if(game.paused){
    resumeGame();
  }
});
PAUSE_BTN.addEventListener('click', ()=> togglePause());
REPLAY_BTN.addEventListener('click', ()=> restartGame());
VIEW_AR_BTN.addEventListener('click', ()=> {
  // El usuario indicó que no se hará AR. Mostramos placeholder.
  alert('Botón AR: En este proyecto solo se implementa el juego HTML. La experiencia AR no está incluida.');
});

function onResize(){
  stageRect = STAGE.getBoundingClientRect();
  stageWidth = stageRect.width;
  stageHeight = stageRect.height;
}

function startGame(){
  resetGame();
  game.running = true;
  game.paused = false;
  START_BTN.textContent = 'Reiniciar';
  PAUSE_BTN.textContent = 'Pausar';
  // pedir permiso para motion (iOS)
  requestDeviceMotionPermission();
  game.lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}

function resetGame(){
  // limpiar cookies visibles
  game.cookies.forEach(c => c.el.remove());
  game.cookies = [];
  game.score = 0;
  SCORE_DISPLAY.textContent = '0';
  END_OVERLAY.style.display = 'none';
  // posicion inicial canasta al centro
  game.basketX = 0.5;
  updateBasketPosition();
}

function restartGame(){
  resetGame();
  startGame();
}

function togglePause(){
  if(!game.running) return;
  game.paused = !game.paused;
  PAUSE_BTN.textContent = game.paused ? 'Reanudar' : 'Pausar';
  if(!game.paused){
    game.lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
}

function resumeGame(){
  if(!game.running) return;
  game.paused = false;
  PAUSE_BTN.textContent = 'Pausar';
  game.lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}

/* --- controles táctiles para arrastrar canasta --- */
let isDragging = false;
let dragStartX = 0;
BASKET.addEventListener('pointerdown', (e)=>{
  isDragging = true;
  dragStartX = e.clientX;
  BASKET.setPointerCapture(e.pointerId);
});
window.addEventListener('pointermove', (e)=>{
  if(isDragging){
    const dx = e.clientX - dragStartX;
    // movemos proporcial
    const rel = dx / stageWidth;
    game.basketX = clamp(game.basketX + rel, 0, 1);
    updateBasketPosition();
    dragStartX = e.clientX;
  }
});
window.addEventListener('pointerup', (e)=>{
  if(isDragging){
    isDragging = false;
  }
});

/* --- controles por swipe en toda la pantalla (alternativa) --- */
let touchStartX = null;
STAGE.addEventListener('touchstart', (e)=>{
  if(e.touches.length === 1){
    touchStartX = e.touches[0].clientX;
  }
});
STAGE.addEventListener('touchmove', (e)=>{
  if(touchStartX === null) return;
  const x = e.touches[0].clientX;
  const dx = x - touchStartX;
  const rel = dx / stageWidth;
  game.basketX = clamp(game.basketX + rel,0,1);
  updateBasketPosition();
  touchStartX = x;
});
STAGE.addEventListener('touchend', ()=> touchStartX = null);

/* --- gyroscope / accelerometer --- */
function requestDeviceMotionPermission(){
  // Safari iOS 13+ requiere permiso
  if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
    DeviceMotionEvent.requestPermission().then(response=>{
      if(response === 'granted'){
        window.addEventListener('devicemotion', onDeviceMotion);
        game.useGyro = true;
      } else {
        // no granted, usa touch
        game.useGyro = false;
      }
    }).catch(()=>{ game.useGyro = false; });
  } else {
    // otros navegadores
    window.addEventListener('devicemotion', onDeviceMotion);
    game.useGyro = true;
  }
}

let gyroBeta = 0;
function onDeviceMotion(ev){
  // Usamos gamma (inclinación izquierda/derecha) si existe
  if(ev.rotationRate && ev.rotationRate.alpha !== undefined){
    // fallback: no todos dan valores consistentes
  }
  // Use deviceorientation event? But devicemotion may not contain orientation.
  // We'll also attach deviceorientation:
}
window.addEventListener('deviceorientation', (e)=>{
  // gamma: tilt left/right (-90 .. 90)
  if(e.gamma !== null && !isNaN(e.gamma)){
    // map gamma (-30..30) to 0..1
    const gamma = clamp(e.gamma, -40, 40);
    const mapped = (gamma + 40) / 80; // 0..1
    // suavizado:
    game.basketX = lerp(game.basketX, mapped, 0.12);
    updateBasketPosition();
    game.useGyro = true;
  }
});

/* --- loop principal --- */
function gameLoop(ts){
  if(!game.running || game.paused) return;
  const dt = (ts - game.lastTime) / 1000; // segundos
  game.lastTime = ts;

  // spawn cookies
  game.lastSpawn += dt * 1000;
  const nextSpawn = game.spawnInterval + (Math.random()*game.spawnVariance - game.spawnVariance/2);
  if(game.lastSpawn > nextSpawn){
    spawnCookie();
    game.lastSpawn = 0;
  }

  // actualizar cookies
  updateCookies(dt);

  // comprobar fin
  if(game.score >= game.goal){
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

function spawnCookie(){
  const el = document.createElement('img');
  el.className = 'cookie';
  // escoger imagen aleatoria
  const src = COOKIE_IMAGES[Math.floor(Math.random()*COOKIE_IMAGES.length)];
  el.src = src;
  el.alt = 'galleta';
  // posición inicial horizontal aleatoria dentro del stage (10%..90%)
  const x = Math.random()*0.8 + 0.1;
  // velocidad en px/s
  const speed = lerp(game.speedMin, game.speedMax, Math.random());
  // pequeña rotación aleatoria
  const rot = (Math.random()*10 - 5);
  el.style.left = (x*100) + '%';
  el.style.top = '-8%';
  el.style.transform = `translate(-50%,0) rotate(${rot}deg)`;
  STAGE.appendChild(el);

  // escala pequeña según tamaño de pantalla
  const scale = clamp(stageWidth/900, 0.6, 1.2);
  el.style.width = (48*scale) + 'px';
  el.style.height = 'auto';

  const cookie = {
    el, x, y: -0.08*stageHeight, // pixels (we'll use computed style instead)
    speed,
    rot,
    rotationDir: Math.random() < 0.5 ? -1 : 1
  };
  // store with pixel x:
  cookie.px = x * stageWidth;
  cookie.py = -50;
  game.cookies.push(cookie);
}

function updateCookies(dt){
  // iteramos en copia para poder eliminar safe
  for(let i = game.cookies.length-1; i >= 0; i--){
    const c = game.cookies[i];
    c.py += c.speed * dt;
    // rotación sutil
    c.rot += 20 * dt * c.rotationDir;
    c.el.style.top = (c.py) + 'px';
    c.el.style.transform = `translate(-50%,0) rotate(${c.rot}deg)`;

    // si sale del fondo
    if(c.py > stageHeight + 80){
      // remover
      c.el.remove();
      game.cookies.splice(i,1);
      continue;
    }

    // colisión con canasta?
    if(checkCollisionWithBasket(c)){
      // animación de captura: escalar y desaparecer
      captureCookie(i);
    }
  }
}

function checkCollisionWithBasket(cookie){
  // bounding boxes
  const bRect = BASKET.getBoundingClientRect();
  const cRect = cookie.el.getBoundingClientRect();
  // reducir caja de la canasta para mejorar la jugabilidad
  const shrink = 0.18;
  const bx1 = bRect.left + bRect.width*shrink;
  const bx2 = bRect.right - bRect.width*shrink;
  const by1 = bRect.top + bRect.height*0.1; // solo topar la parte superior
  const by2 = bRect.bottom;
  const cx1 = cRect.left;
  const cx2 = cRect.right;
  const cy1 = cRect.top;
  const cy2 = cRect.bottom;
  const overlap = !(cx2 < bx1 || cx1 > bx2 || cy2 < by1 || cy1 > by2);
  return overlap;
}

function captureCookie(index){
  const c = game.cookies[index];
  // efecto bounce en la canasta
  bounceBasket();
  // aumentar score
  game.score += 1;
  SCORE_DISPLAY.textContent = String(game.score);
  // efecto visual cookie: escala + fade
  c.el.style.transition = 'transform 260ms ease, opacity 300ms ease';
  c.el.style.transform += ' scale(0.4)';
  c.el.style.opacity = '0';
  // remover luego
  setTimeout(()=>{ try{ c.el.remove(); }catch(e){} }, 320);
  game.cookies.splice(index,1);
  // ajustar dificultad leve cada cierto puntaje (opcional)
  if(game.score % 5 === 0){
    // hacer spawn más rápido y/o aumentar velocidad máxima
    game.spawnInterval = Math.max(350, game.spawnInterval - 40);
    game.speedMax = Math.min(420, game.speedMax + 10);
  }
}

function bounceBasket(){
  BASKET.animate([
    { transform: BASKET.style.transform + ' translateY(0px)' },
    { transform: BASKET.style.transform + ' translateY(-8px)' },
    { transform: BASKET.style.transform + ' translateY(0px)' }
  ], { duration: 280, easing: 'cubic-bezier(.17,.67,.47,1.69)'});
}

/* coloca la canasta según game.basketX (0..1) */
function updateBasketPosition(){
  const x = clamp(game.basketX,0,1);
  // posición en px centrada: left = x*stageWidth
  const leftPx = x * stageWidth;
  BASKET.style.left = leftPx + 'px';
  BASKET.style.transform = 'translateX(-50%)';
}

/* fin de juego */
function endGame(){
  game.running = false;
  END_OVERLAY.style.display = 'flex';
  document.getElementById('endTitle').textContent = '¡Felicidades!';
  document.getElementById('endText').textContent = `Atrapaste ${game.score} galletas.`;
}

/* util */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function lerp(a,b,t){ return a + (b-a) * t; }

/* inicial */
(function init(){
  // posicion inicial basket
  onResize();
  game.basketX = 0.5;
  updateBasketPosition();

  // preload images
  COOKIE_IMAGES.forEach(src => { const i = new Image(); i.src = src; });
  const basketImg = new Image(); basketImg.src = BASKET.querySelector('img')?.src || '';

  // shortcuts keyboard: space to start/pause
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){ e.preventDefault(); if(!game.running) startGame(); else togglePause(); }
  });
})();
</script>
</body>
</html>
